{-# LANGUAGE OverloadedStrings #-}
module Main(main) where

import Prelude
import Test.HUnit
import CedilleTypes
import CedilleLexer hiding (main)
import CedilleParser hiding (main)
import Control.Arrow
import Control.Monad
import System.IO  
import qualified System.Exit as Exit
import Data.Text (Text, pack)

removeLexerPositions :: Either a [Token] -> Either a [TokenClass]
removeLexerPositions = right (map (\ (Token _ tc) -> tc))

test_lexer_str = "aaa"

test_lexer = TestCase (assertEqual "test lexer 0"
                        (removeLexerPositions (scanner test_lexer_str))
                        (Prelude.Right [TVar "aaa"]))

test_parser_str = unlines [
  "import ../hello/world . %comments",
  "import module . ",
  "%comments 2 ",
  "module Test . "
  ]

test_parser_module = TestCase (assertEqual "test parser 0"
                               (Prelude.Right (File "0" ImportsStart "Test" ParamsNil CmdsStart "34"))
                               (runAlex test_parser_str $ cedilleParser))

-- test_atype_hole_str = "  ●"
-- test_atype_hole = TestCase (assertEqual "test atype Hole"
--                        (Prelude.Right (TpHole (AlexPn 2 1 3)))
--                        (runAlex test_atype_hole_str $ atypes))

-- test_atype_qvar_str = " aaa "
-- test_atype_qvar = TestCase (assertEqual "test atype Qvar"
--                             (Prelude.Right (TpVar (AlexPn 1 1 2) "aaa"))
--                             (runAlex test_atype_qvar_str $ atypes))

-- test_atype_qvar2_str = " aaa.bbb.ccc "
-- test_atype_qvar2 = TestCase (assertEqual "test atype Qvar Qualified"
--                             (Prelude.Right (TpVar (AlexPn 1 1 2) "aaa.bbb.ccc"))
--                             (runAlex test_atype_qvar2_str $ atypes))


test_type_arrow_str = " cNat ➔ cNat "

test_type_arrow = TestCase (assertEqual "test type Arrow"
                             (Prelude.Right (TpArrow (TpVar "1" "cNat") UnerasedArrow (TpVar "8" "cNat")))
                             (runAlex test_type_arrow_str $ types))

test_parser_term_str = unlines [
  " Λ X . λ f . λ a . a  " ,
  ""                                             
  ]

test_parser_term = TestCase (assertEqual "test parser term"
                               (Prelude.Right (Lam "1" ErasedLambda "3" "X" NoClass (Lam "7" KeptLambda "9" "f" NoClass (Lam "13" KeptLambda "15" "a" NoClass (Var "19" "a")))))
                               (runAlex test_parser_term_str $ term))

test_parser_deftermtype_str = unlines [
    "cZ ◂ cNat = Λ X . λ f . λ a . a  " ,
--    "cS ◂ X ➔ X = a "  ,
    ""
  ]

test_parser_deftermtype = TestCase (assertEqual "test parser definition"
                                   (Prelude.Right (DefTerm "0" "cZ" (Type (TpVar "5" "cNat")) (Lam "12" ErasedLambda "14" "X" NoClass (Lam "18" KeptLambda "20" "f" NoClass (Lam "24" KeptLambda "26" "a" NoClass (Var "30" "a"))))))
                                (runAlex test_parser_deftermtype_str $ deftermtype))

test_parser_cmd_str = unlines [
--  "import ChurchNat ." ,                         
--  "cNat ◂ ★ = ∀ X : ★ . (X ➔ X) ➔ X ➔ X . " ,
--  "cZ ◂ cNat = Λ X . λ f . λ a . a.1  . " ,
    "cS ◂ X ➔ X  = λ n . Λ X . λ f . λ a . f (n · X f a) . "  ,
    " "
  ]

test_parser_cmd = TestCase (assertEqual "test parser command"
                            (Prelude.Right (DefTermOrType (DefTerm "0" "cS" (Type (TpArrow (TpVar "5" "X") UnerasedArrow (TpVar "9" "X"))) (Lam "14" KeptLambda "16" "n" NoClass (Lam "20" ErasedLambda "22" "X" NoClass (Lam "26" KeptLambda "28" "f" NoClass (Lam "32" KeptLambda "34" "a" NoClass (App (Var "38" "f") NotErased (Parens "40" (App (App (AppTp (Var "41" "n") (TpVar "45" "X")) NotErased (Var "47" "f")) NotErased (Var "49" "a")) "51"))))))) "53"))
                               (runAlex test_parser_cmd_str $ cmd))

-- Problem shift-reduce confict in state 12 causes it is not correctly parsed

test_parser_liftingtype_str = unlines [
--  "    Π a : a . a ➔ ☆   "
    "     a ➔↑ ☆   "
  ]

test_parser_liftingtype = TestCase (assertEqual "test parser lifting type"
                                    (Prelude.Right (LiftTpArrow (TpVar "5" "a") (LiftStar "10")))
                                    (runAlex test_parser_liftingtype_str $ liftingtype))

test_parser_cnat_str = unlines [
  "module ChurchNat ."                         ,
  ""                                           ,
  "cNat ◂ ★ = ∀ X : ★ . (X ➔ X) ➔ X ➔ X . " ,
  ""                                           ,
  "cZ ◂ cNat = Λ X . λ f . λ a . a . "         ,
  ""                                           ,
  "cS ◂ cNat ➔ cNat = λ n . Λ X . λ f . λ a . f (n · X f a) . "
  ]

test_parser_cnat = TestCase (assertEqual "test parser cnat module"
                               (Prelude.Right
                                (File "0" ImportsStart "ChurchNat" ParamsNil (CmdsNext (DefTermOrType (DefType "20" "cNat" (Star "27") (Abs "31" All "33" "X" (Tkk (Star "37")) (TpArrow (TpParens "41" (TpArrow (TpVar "42" "X") UnerasedArrow (TpVar "46" "X")) "48") UnerasedArrow (TpArrow (TpVar "51" "X") UnerasedArrow (TpVar "55" "X"))))) "58") (CmdsNext (DefTermOrType (DefTerm "61" "cZ" (Type (TpVar "66" "cNat")) (Lam "73" ErasedLambda "75" "X" NoClass (Lam "79" KeptLambda "81" "f" NoClass (Lam "85" KeptLambda "87" "a" NoClass (Var "91" "a"))))) "94") (CmdsNext (DefTermOrType (DefTerm "97" "cS" (Type (TpArrow (TpVar "102" "cNat") UnerasedArrow (TpVar "109" "cNat"))) (Lam "116" KeptLambda "118" "n" NoClass (Lam "122" ErasedLambda "124" "X" NoClass (Lam "128" KeptLambda "130" "f" NoClass (Lam "134" KeptLambda "136" "a" NoClass (App (Var "140" "f") NotErased (Parens "142" (App (App (AppTp (Var "143" "n") (TpVar "147" "X")) NotErased (Var "149" "f")) NotErased (Var "151" "a")) "153"))))))) "155") CmdsStart))) "157"))
                               (runAlex test_parser_cnat_str $ cedilleParser))

test_cnat = TestCase (do
                        cnt <- readFile "test/tests/cnat.ced"
                        (assertEqual "test file cnat.ced"
                          (Prelude.Right (File "0" ImportsStart "Cnat" ParamsNil (CmdsNext (DefTermOrType (DefType "15" "cNat" (Star "22") (Abs "26" All "28" "X" (Tkk (Star "32")) (TpArrow (TpParens "36" (TpArrow (TpVar "37" "X") UnerasedArrow (TpVar "41" "X")) "43") UnerasedArrow (TpArrow (TpVar "46" "X") UnerasedArrow (TpVar "50" "X"))))) "53") (CmdsNext (DefTermOrType (DefTerm "55" "cZ" (Type (TpVar "60" "cNat")) (Lam "67" ErasedLambda "69" "X" NoClass (Lam "73" KeptLambda "75" "f" NoClass (Lam "79" KeptLambda "81" "a" NoClass (Var "85" "a"))))) "88") (CmdsNext (DefTermOrType (DefTerm "90" "cS" (Type (TpArrow (TpVar "95" "cNat") UnerasedArrow (TpVar "102" "cNat"))) (Lam "109" KeptLambda "111" "n" NoClass (Lam "115" ErasedLambda "117" "X" NoClass (Lam "121" KeptLambda "123" "f" NoClass (Lam "127" KeptLambda "129" "a" NoClass (App (Var "133" "f") NotErased (Parens "135" (App (App (AppTp (Var "136" "n") (TpVar "140" "X")) NotErased (Var "142" "f")) NotErased (Var "144" "a")) "146"))))))) "148") CmdsStart))) "152"))                                       (runAlex cnt $ cedilleParser)))

test_nat = TestCase (do
                        cnt <- readFile "test/tests/nat.ced"
                        (assertEqual "test file nat.ced"
                          (Prelude.Right (File "0" ImportsStart "Nat" ParamsNil (CmdsNext (ImportCmd (Import "14" "cnat" NoOptAs (ArgsNil "25") "26")) (CmdsNext (DefTermOrType (DefType "28" "cNatInductive" (KndTpArrow (TpVar "44" "cNat") (Star "51")) (TpLambda "55" "57" "x" (Tkt (TpVar "61" "cNat")) (Abs "68" All "70" "Q" (Tkk (KndTpArrow (TpVar "74" "cNat") (Star "81"))) (TpArrow (TpParens "85" (Abs "86" All "88" "x" (Tkt (TpVar "92" "cNat")) (TpArrow (TpAppt (TpVar "99" "Q") (Var "101" "x")) UnerasedArrow (TpAppt (TpVar "105" "Q") (Parens "107" (App (Var "108" "cS") NotErased (Var "111" "x")) "113")))) "114") UnerasedArrow (TpArrow (TpAppt (TpVar "117" "Q") (Var "119" "cZ")) UnerasedArrow (TpAppt (TpVar "124" "Q") (Var "126" "x"))))))) "128") (CmdsNext (DefTermOrType (DefType "130" "Nat" (Star "136") (Iota "140" "142" "x" (SomeType (TpVar "146" "cNat")) (TpAppt (TpVar "153" "cNatInductive") (Var "167" "x")))) "169") (CmdsNext (DefTermOrType (DefTerm "171" "Z" (Type (TpVar "175" "Nat")) (IotaPair "181" (Var "183" "cZ") (Lam "188" ErasedLambda "190" "X" NoClass (Lam "194" KeptLambda "196" "s" NoClass (Lam "200" KeptLambda "202" "z" NoClass (Var "206" "z")))) NoTerm "209")) "211") (CmdsNext (DefTermOrType (DefTerm "212" "S" (Type (TpArrow (TpVar "216" "Nat") UnerasedArrow (TpVar "222" "Nat"))) (Lam "228" KeptLambda "230" "n" NoClass (IotaPair "234" (App (Var "236" "cS") NotErased (IotaProj (Var "239" "n") "1" "242")) (Lam "245" ErasedLambda "247" "P" NoClass (Lam "251" KeptLambda "253" "s" NoClass (Lam "257" KeptLambda "259" "z" NoClass (App (App (Var "263" "s") Erased (IotaProj (Var "266" "n") "1" "269")) NotErased (Parens "270" (App (App (AppTp (IotaProj (Var "271" "n") "2" "274") (TpVar "277" "P")) NotErased (Var "279" "s")) NotErased (Var "281" "z")) "283"))))) NoTerm "285"))) "287") (CmdsNext (DefTermOrType (DefTerm "289" "NatRec" (Type (TpArrow (TpVar "298" "Nat") UnerasedArrow (TpVar "304" "cNat"))) (Lam "311" KeptLambda "313" "n" NoClass (IotaProj (Var "317" "n") "1" "320"))) "322") (CmdsNext (DefTermOrType (DefTerm "324" "add" (Type (TpArrow (TpVar "330" "Nat") UnerasedArrow (TpArrow (TpVar "336" "Nat") UnerasedArrow (TpVar "342" "Nat")))) (Lam "348" KeptLambda "350" "m" NoClass (Lam "354" KeptLambda "356" "n" NoClass (App (App (AppTp (App (Var "360" "NatRec") NotErased (Var "367" "m")) (TpVar "371" "Nat")) NotErased (Var "375" "S")) NotErased (Var "377" "n"))))) "380") (CmdsNext (DefTermOrType (DefTerm "382" "mult" (Type (TpArrow (TpVar "389" "Nat") UnerasedArrow (TpArrow (TpVar "395" "Nat") UnerasedArrow (TpVar "401" "Nat")))) (Lam "407" KeptLambda "409" "m" NoClass (Lam "413" KeptLambda "415" "n" NoClass (App (App (AppTp (App (Var "419" "NatRec") NotErased (Var "426" "m")) (TpVar "430" "Nat")) NotErased (Parens "434" (App (Var "435" "add") NotErased (Var "439" "n")) "441")) NotErased (Var "442" "Z"))))) "445") (CmdsNext (DefTermOrType (DefTerm "447" "exp" (Type (TpArrow (TpVar "453" "Nat") UnerasedArrow (TpArrow (TpVar "459" "Nat") UnerasedArrow (TpVar "465" "Nat")))) (Lam "471" KeptLambda "473" "m" NoClass (Lam "477" KeptLambda "479" "n" NoClass (App (App (AppTp (App (Var "483" "NatRec") NotErased (Var "490" "n")) (TpVar "494" "Nat")) NotErased (Parens "498" (App (Var "499" "mult") NotErased (Var "504" "m")) "506")) NotErased (Parens "507" (App (Var "508" "S") NotErased (Var "510" "Z")) "512"))))) "514") (CmdsNext (DefTermOrType (DefTerm "516" "NatInd" (Type (Abs "525" Pi "527" "x" (Tkt (TpVar "531" "Nat")) (Abs "537" All "539" "Q" (Tkk (KndTpArrow (TpVar "543" "Nat") (Star "549"))) (TpArrow (TpParens "553" (Abs "554" All "556" "x" (Tkt (TpVar "560" "Nat")) (TpArrow (TpAppt (TpVar "566" "Q") (Var "568" "x")) UnerasedArrow (TpAppt (TpVar "572" "Q") (Parens "574" (App (Var "575" "S") NotErased (Var "577" "x")) "579")))) "580") UnerasedArrow (TpArrow (TpAppt (TpVar "583" "Q") (Var "585" "Z")) UnerasedArrow (TpAppt (TpVar "589" "Q") (Var "591" "x"))))))) (Lam "597" KeptLambda "599" "x" NoClass (Lam "603" ErasedLambda "605" "Q" NoClass (Lam "609" KeptLambda "611" "s" NoClass (Lam "615" KeptLambda "617" "z" NoClass (App (AppTp (App (App (AppTp (App (Var "621" "a") NotErased (IotaProj (Var "627" "x") "2" "630")) (TpParens "633" (TpLambda "634" "636" "x" (Tkt (TpVar "640" "cNat")) (Abs "647" All "649" "X" (Tkk (Star "653")) (TpArrow (TpParens "657" (Abs "658" Pi "660" "x'" (Tkt (TpVar "665" "Nat")) (TpArrow (TpParens "671" (TpEq (Var "674" "x") (Var "678" "x'")) "683") UnerasedArrow (TpArrow (TpAppt (TpVar "686" "Q") (Var "688" "x'")) UnerasedArrow (TpVar "693" "X")))) "695") UnerasedArrow (TpVar "698" "X")))) "700")) NotErased (Parens "706" (Lam "707" ErasedLambda "709" "x'" NoClass (Lam "714" KeptLambda "716" "ih" NoClass (Lam "721" ErasedLambda "723" "X" NoClass (Lam "727" KeptLambda "729" "c" NoClass (App (AppTp (Var "733" "ih") (TpVar "738" "X")) NotErased (Parens "740" (Lam "741" KeptLambda "743" "x''" NoClass (Lam "749" KeptLambda "751" "e" NoClass (Lam "755" KeptLambda "757" "u" NoClass (App (App (App (Var "761" "c") NotErased (Parens "763" (App (Var "764" "S") NotErased (Var "766" "x''")) "770")) NotErased (Parens "771" (Rho "772" RhoPlain (Var "774" "e") (Beta "778" NoTerm)) "780")) NotErased (Parens "781" (App (App (Var "782" "s") Erased (Var "785" "x''")) NotErased (Var "789" "u")) "791"))))) "792")))))) "793")) NotErased (Parens "799" (Lam "800" ErasedLambda "802" "X" NoClass (Lam "806" KeptLambda "808" "c" NoClass (App (App (App (Var "812" "c") NotErased (Var "814" "Z")) NotErased (Beta "816" NoTerm)) NotErased (Var "818" "z")))) "820")) (TpParens "823" (TpAppt (TpVar "824" "Q") (Var "826" "x")) "828")) NotErased (Parens "829" (Lam "830" KeptLambda "832" "x'" NoClass (Lam "837" KeptLambda "839" "e" NoClass (Lam "843" KeptLambda "845" "u" NoClass (Rho "849" RhoPlain (Var "851" "e") (Var "855" "u"))))) "857"))))))) "858") CmdsStart)))))))))) "862"))
                          (runAlex cnt $ cedilleParser)))

test_clist = TestCase (do
                        cnt <- readFile "test/tests/clist.ced"
                        (assertEqual "test file clist.ced"
                          (Prelude.Right (File "0" ImportsStart "Clist" ParamsNil (CmdsNext (DefTermOrType (DefType "16" "cList" (KndArrow (Star "24") (Star "28")) (TpLambda "32" "34" "A" (Tkk (Star "38")) (Abs "42" All "44" "X" (Tkk (Star "48")) (TpArrow (TpParens "52" (TpArrow (TpVar "53" "A") UnerasedArrow (TpArrow (TpVar "57" "X") UnerasedArrow (TpVar "61" "X"))) "63") UnerasedArrow (TpArrow (TpVar "66" "X") UnerasedArrow (TpVar "70" "X")))))) "73") (CmdsNext (DefTermOrType (DefTerm "75" "cNil" (Type (Abs "82" All "84" "A" (Tkk (Star "88")) (TpApp (TpVar "92" "cList") (TpVar "100" "A")))) (Lam "104" ErasedLambda "106" "A" NoClass (Lam "110" ErasedLambda "112" "X" NoClass (Lam "116" KeptLambda "118" "c" NoClass (Lam "122" KeptLambda "124" "n" NoClass (Var "128" "n")))))) "131") (CmdsNext (DefTermOrType (DefTerm "133" "cCons" (Type (Abs "141" All "143" "A" (Tkk (Star "147")) (TpArrow (TpVar "151" "A") UnerasedArrow (TpArrow (TpApp (TpVar "155" "cList") (TpVar "163" "A")) UnerasedArrow (TpApp (TpVar "167" "cList") (TpVar "175" "A")))))) (Lam "179" ErasedLambda "181" "A" NoClass (Lam "185" KeptLambda "187" "h" NoClass (Lam "191" KeptLambda "193" "t" NoClass (Lam "197" ErasedLambda "199" "X" NoClass (Lam "203" KeptLambda "205" "c" NoClass (Lam "209" KeptLambda "211" "n" NoClass (App (App (Var "215" "c") NotErased (Var "217" "h")) NotErased (Parens "219" (App (App (AppTp (Var "220" "t") (TpVar "224" "X")) NotErased (Var "226" "c")) NotErased (Var "228" "n")) "230"))))))))) "232") CmdsStart))) "233"))                          
                          (runAlex cnt $ cedilleParser)))

test_list = TestCase (do
                        cnt <- readFile "test/tests/list.ced"
                        (assertEqual "test file list.ced"
                          (Prelude.Right (File "0" ImportsStart "List" ParamsNil (CmdsNext (ImportCmd (Import "15" "clist" NoOptAs (ArgsNil "27") "28")) (CmdsNext (ImportCmd (Import "29" "nat" NoOptAs (ArgsNil "39") "40")) (CmdsNext (DefTermOrType (DefType "42" "cListParametric" (KndPi "60" "62" "A" (Tkk (Star "66")) (KndTpArrow (TpApp (TpVar "70" "cList") (TpVar "78" "A")) (Star "82"))) (TpLambda "88" "90" "A" (Tkk (Star "94")) (TpLambda "98" "100" "l" (Tkt (TpApp (TpVar "104" "cList") (TpVar "112" "A"))) (Abs "116" All "118" "X" (Tkk (Star "122")) (Abs "126" All "128" "Q" (Tkk (KndTpArrow (TpVar "132" "X") (Star "136"))) (Abs "140" All "142" "cons" (Tkt (TpArrow (TpVar "149" "A") UnerasedArrow (TpArrow (TpVar "153" "X") UnerasedArrow (TpVar "157" "X")))) (Abs "161" All "163" "nil" (Tkt (TpVar "169" "X")) (TpArrow (TpParens "178" (Abs "179" Pi "181" "h" (Tkt (TpVar "185" "A")) (Abs "189" All "191" "t" (Tkt (TpVar "195" "X")) (TpArrow (TpAppt (TpVar "199" "Q") (Var "201" "t")) UnerasedArrow (TpAppt (TpVar "205" "Q") (Parens "207" (App (App (Var "208" "cons") NotErased (Var "213" "h")) NotErased (Var "215" "t")) "217"))))) "218") UnerasedArrow (TpArrow (TpAppt (TpVar "221" "Q") (Var "223" "nil")) UnerasedArrow (TpAppt (TpVar "229" "Q") (Parens "231" (App (App (AppTp (Var "232" "l") (TpVar "236" "X")) NotErased (Var "238" "cons")) NotErased (Var "243" "nil")) "247"))))))))))) "249") (CmdsNext (DefTermOrType (DefType "251" "List" (KndArrow (Star "258") (Star "262")) (TpLambda "266" "268" "A" (Tkk (Star "272")) (Iota "276" "278" "x" (SomeType (TpApp (TpVar "282" "cList") (TpVar "290" "A"))) (Iota "294" "296" "_" (SomeType (TpEq (App (App (Var "302" "x") NotErased (Var "304" "cCons")) NotErased (Var "310" "cNil")) (Var "317" "x"))) (TpAppt (TpApp (TpVar "323" "cListParametric") (TpVar "341" "A")) (Var "343" "x")))))) "346") (CmdsNext (DefTermOrType (DefTerm "348" "Nil" (Type (Abs "354" All "356" "A" (Tkk (Star "360")) (TpApp (TpVar "364" "List") (TpVar "371" "A")))) (Lam "375" ErasedLambda "377" "A" NoClass (IotaPair "381" (AppTp (Var "383" "cNil") (TpVar "390" "A")) (IotaPair "394" (Beta "396" (SomeTerm (Var "398" "cNil") "403")) (Lam "406" ErasedLambda "408" "Q" NoClass (Lam "412" ErasedLambda "414" "Q" NoClass (Lam "418" ErasedLambda "420" "cons" NoClass (Lam "427" ErasedLambda "429" "nil" NoClass (Lam "435" KeptLambda "437" "c" NoClass (Lam "441" KeptLambda "443" "n" NoClass (Var "447" "n"))))))) NoTerm "450") NoTerm "452"))) "453") (CmdsNext (DefTermOrType (DefTerm "455" "Cons" (Type (Abs "462" All "464" "A" (Tkk (Star "468")) (TpArrow (TpVar "472" "A") UnerasedArrow (TpArrow (TpApp (TpVar "476" "List") (TpVar "483" "A")) UnerasedArrow (TpApp (TpVar "487" "List") (TpVar "494" "A")))))) (Lam "500" ErasedLambda "502" "A" NoClass (Lam "506" KeptLambda "508" "h" NoClass (Lam "512" KeptLambda "514" "t" NoClass (IotaPair "522" (App (App (AppTp (Var "524" "cCons") (TpVar "532" "A")) NotErased (Var "534" "h")) NotErased (IotaProj (Var "536" "t") "1" "539")) (IotaPair "546" (Epsilon "548" Both EpsHnf (Rho "550" RhoPlain (IotaProj (IotaProj (Var "552" "t") "2" "555") "1" "557") (Beta "560" (SomeTerm (App (App (Var "562" "cCons") NotErased (Var "568" "h")) NotErased (Var "570" "t")) "572")))) (Lam "581" ErasedLambda "583" "X" NoClass (Lam "587" ErasedLambda "589" "Q" NoClass (Lam "593" ErasedLambda "595" "cons" NoClass (Lam "602" ErasedLambda "604" "nil" NoClass (Lam "610" KeptLambda "612" "c" NoClass (Lam "616" KeptLambda "618" "n" NoClass (App (App (App (Var "622" "c") NotErased (Var "624" "h")) Erased (Parens "627" (App (App (AppTp (IotaProj (Var "628" "t") "1" "631") (TpVar "634" "X")) NotErased (Var "636" "cons")) NotErased (Var "641" "nil")) "645")) NotErased (Parens "646" (App (App (App (App (AppTp (AppTp (IotaProj (IotaProj (Var "647" "t") "2" "650") "2" "652") (TpVar "655" "X")) (TpVar "659" "Q")) Erased (Var "662" "cons")) Erased (Var "668" "nil")) NotErased (Var "672" "c")) NotErased (Var "674" "n")) "676")))))))) NoTerm "678") NoTerm "680"))))) "681") (CmdsNext (DefTermOrType (DefTerm "683" "ListRec" (Type (Abs "693" All "695" "A" (Tkk (Star "699")) (TpArrow (TpApp (TpVar "703" "List") (TpVar "710" "A")) UnerasedArrow (TpApp (TpVar "714" "cList") (TpVar "722" "A"))))) (Lam "726" ErasedLambda "728" "A" NoClass (Lam "732" KeptLambda "734" "l" NoClass (IotaProj (Var "738" "l") "1" "741")))) "743") (CmdsNext (DefTermOrType (DefTerm "745" "ListInd" (Type (Abs "755" All "757" "A" (Tkk (Star "761")) (Abs "765" Pi "767" "l" (Tkt (TpApp (TpVar "771" "List") (TpVar "778" "A"))) (Abs "792" All "794" "P" (Tkk (KndTpArrow (TpApp (TpVar "798" "List") (TpVar "805" "A")) (Star "809"))) (TpArrow (TpParens "823" (Abs "824" Pi "826" "h" (Tkt (TpVar "830" "A")) (Abs "834" All "836" "t" (Tkt (TpApp (TpVar "840" "List") (TpVar "847" "A"))) (TpArrow (TpAppt (TpVar "851" "P") (Var "853" "t")) UnerasedArrow (TpAppt (TpVar "857" "P") (Parens "859" (App (App (AppTp (Var "860" "Cons") (TpVar "867" "A")) NotErased (Var "869" "h")) NotErased (Var "871" "t")) "873"))))) "874") UnerasedArrow (TpArrow (TpAppt (TpVar "887" "P") (Parens "889" (AppTp (Var "890" "Nil") (TpVar "896" "A")) "898")) UnerasedArrow (TpAppt (TpVar "911" "P") (Var "913" "l")))))))) (Lam "917" ErasedLambda "919" "A" NoClass (Lam "923" KeptLambda "925" "l" NoClass (Lam "929" ErasedLambda "931" "P" NoClass (Lam "935" KeptLambda "937" "c" NoClass (Lam "941" KeptLambda "943" "n" NoClass (Rho "947" RhoPlain (Sigma "949" (IotaProj (IotaProj (Var "951" "l") "2" "954") "1" "956")) (Parens "959" (App (App (App (App (AppTp (AppTp (IotaProj (IotaProj (Var "960" "l") "2" "963") "2" "965") (TpParens "968" (TpApp (TpVar "969" "List") (TpVar "976" "A")) "978")) (TpVar "981" "P")) Erased (Parens "984" (AppTp (Var "985" "Cons") (TpVar "992" "A")) "994")) Erased (Parens "996" (AppTp (Var "997" "Nil") (TpVar "1003" "A")) "1005")) NotErased (Var "1006" "c")) NotErased (Var "1008" "n")) "1010")))))))) "1012") (CmdsNext (DefTermOrType (DefTerm "1014" "append" (Type (Abs "1023" All "1025" "A" (Tkk (Star "1029")) (TpArrow (TpApp (TpVar "1033" "List") (TpVar "1040" "A")) UnerasedArrow (TpArrow (TpApp (TpVar "1044" "List") (TpVar "1051" "A")) UnerasedArrow (TpApp (TpVar "1055" "List") (TpVar "1062" "A")))))) (Lam "1068" ErasedLambda "1070" "A" NoClass (Lam "1074" KeptLambda "1076" "l1" NoClass (Lam "1081" KeptLambda "1083" "l2" NoClass (App (App (AppTp (App (AppTp (Var "1092" "ListRec") (TpVar "1102" "A")) NotErased (Var "1104" "l1")) (TpParens "1109" (TpApp (TpVar "1110" "List") (TpVar "1117" "A")) "1119")) NotErased (Parens "1126" (AppTp (Var "1127" "Cons") (TpVar "1134" "A")) "1136")) NotErased (Var "1143" "l2")))))) "1147") (CmdsNext (DefTermOrType (DefTerm "1149" "length" (Type (Abs "1158" All "1160" "A" (Tkk (Star "1164")) (TpArrow (TpApp (TpVar "1168" "List") (TpVar "1175" "A")) UnerasedArrow (TpVar "1179" "Nat")))) (Lam "1186" ErasedLambda "1188" "A" NoClass (Lam "1192" KeptLambda "1194" "l" NoClass (App (App (AppTp (App (AppTp (Var "1201" "ListRec") (TpVar "1211" "A")) NotErased (Var "1213" "l")) (TpVar "1217" "Nat")) NotErased (Parens "1226" (Lam "1227" KeptLambda "1229" "_" NoClass (Var "1233" "S")) "1235")) NotErased (Var "1236" "Z"))))) "1239") (CmdsNext (DefTermOrType (DefTerm "1241" "map" (Type (Abs "1247" All "1249" "A" (Tkk (Star "1253")) (Abs "1257" All "1259" "B" (Tkk (Star "1263")) (TpArrow (TpParens "1267" (TpArrow (TpVar "1268" "A") UnerasedArrow (TpVar "1272" "B")) "1274") UnerasedArrow (TpArrow (TpApp (TpVar "1277" "List") (TpVar "1284" "A")) UnerasedArrow (TpApp (TpVar "1288" "List") (TpVar "1295" "B"))))))) (Lam "1301" ErasedLambda "1303" "A" NoClass (Lam "1307" ErasedLambda "1309" "B" NoClass (Lam "1313" KeptLambda "1315" "f" NoClass (Lam "1319" KeptLambda "1321" "l" NoClass (App (App (AppTp (App (AppTp (Var "1325" "ListRec") (TpVar "1335" "A")) NotErased (Var "1337" "l")) (TpParens "1341" (TpApp (TpVar "1342" "List") (TpVar "1349" "B")) "1351")) NotErased (Parens "1352" (Lam "1353" KeptLambda "1355" "a" NoClass (Lam "1359" KeptLambda "1361" "bl" NoClass (App (App (AppTp (Var "1366" "Cons") (TpVar "1373" "B")) NotErased (Parens "1375" (App (Var "1376" "f") NotErased (Var "1378" "a")) "1380")) NotErased (Var "1381" "bl")))) "1384")) NotErased (Parens "1385" (AppTp (Var "1386" "Nil") (TpVar "1392" "B")) "1394"))))))) "1396") (CmdsNext (DefTermOrType (DefTerm "1398" "foldr" (Type (Abs "1406" All "1408" "A" (Tkk (Star "1412")) (Abs "1416" All "1418" "B" (Tkk (Star "1422")) (TpArrow (TpParens "1426" (TpArrow (TpVar "1427" "A") UnerasedArrow (TpArrow (TpVar "1431" "B") UnerasedArrow (TpVar "1435" "B"))) "1437") UnerasedArrow (TpArrow (TpVar "1440" "B") UnerasedArrow (TpArrow (TpApp (TpVar "1444" "List") (TpVar "1451" "A")) UnerasedArrow (TpVar "1455" "B"))))))) (Lam "1461" ErasedLambda "1463" "A" NoClass (Lam "1467" ErasedLambda "1469" "B" NoClass (Lam "1473" KeptLambda "1475" "f" NoClass (Lam "1479" KeptLambda "1481" "i" NoClass (Lam "1485" KeptLambda "1487" "l" NoClass (App (App (AppTp (App (AppTp (Var "1491" "ListRec") (TpVar "1501" "A")) NotErased (Var "1503" "l")) (TpVar "1507" "B")) NotErased (Var "1509" "f")) NotErased (Var "1511" "i")))))))) "1514") CmdsStart)))))))))))) "1515"))
                          (runAlex cnt $ cedilleParser)))

-- test liftingtype conflict resolution
test_lifttypes = TestCase (do
                        cnt <- readFile "test/tests/descn.ced"
                        (assertEqual "test file descn.ced"
                          (Prelude.Right (File "0" ImportsStart "descn" ParamsNil (CmdsNext (ImportCmd (Import "15" "or" NoOptAs (ArgsNil "24") "25")) (CmdsNext (ImportCmd (Import "26" "and" NoOptAs (ArgsNil "36") "37")) (CmdsNext (ImportCmd (Import "38" "true" NoOptAs (ArgsNil "49") "50")) (CmdsNext (ImportCmd (Import "51" "nat" NoOptAs (ArgsNil "61") "62")) (CmdsNext (DefTermOrType (DefType "64" "Fin" (KndTpArrow (TpVar "70" "Nat") (Star "76")) (TpLambda "80" "82" "x" (Tkt (TpVar "86" "Nat")) (TpVar "92" "Nat"))) "97") (CmdsNext (DefTermOrType (DefType "151" "Desc" (KndTpArrow (TpVar "158" "Nat") (Star "164")) (TpLambda "168" "170" "n" (Tkt (TpVar "174" "Nat")) (Abs "197" All "199" "X" (Tkk (Star "203")) (TpArrow (TpParens "230" (TpArrow (TpVar "231" "X") UnerasedArrow (TpArrow (TpVar "235" "X") UnerasedArrow (TpVar "239" "X"))) "241") UnerasedArrow (TpArrow (TpParens "271" (TpArrow (TpVar "272" "X") UnerasedArrow (TpArrow (TpVar "276" "X") UnerasedArrow (TpVar "280" "X"))) "282") UnerasedArrow (TpArrow (TpVar "316" "X") UnerasedArrow (TpArrow (TpParens "348" (TpArrow (TpAppt (TpVar "349" "Fin") (Var "353" "n")) UnerasedArrow (TpVar "357" "X")) "359") UnerasedArrow (TpArrow (TpVar "401" "X") UnerasedArrow (TpVar "445" "X"))))))))) "448") (CmdsNext (DefTermOrType (DefType "450" "interp" (KndPi "459" "461" "n" (Tkt (TpVar "465" "Nat")) (KndTpArrow (TpAppt (TpVar "471" "Desc") (Var "476" "n")) (KndArrow (KndParens "480" (KndTpArrow (TpAppt (TpVar "481" "Fin") (Var "485" "n")) (Star "489")) "491") (KndArrow (Star "494") (Star "498"))))) (TpLambda "504" "506" "n" (Tkt (TpVar "510" "Nat")) (TpLambda "516" "518" "d" (Tkt (TpAppt (TpVar "522" "Desc") (Var "527" "n"))) (TpLambda "531" "533" "A" (Tkk (KndParens "537" (KndTpArrow (TpAppt (TpVar "538" "Fin") (Var "542" "n")) (Star "546")) "548")) (TpLambda "553" "555" "X" (Tkk (Star "559")) (TpApp (TpApp (TpApp (TpApp (TpApp (TpParens "563" (Lft "564" "566" "Z" (AppTp (Var "570" "d") (TpVar "574" "Z")) (LiftParens "578" (LiftArrow (LiftParens "579" (LiftArrow (LiftStar "580") (LiftArrow (LiftStar "585") (LiftStar "590"))) "592") (LiftArrow (LiftParens "596" (LiftArrow (LiftStar "597") (LiftArrow (LiftStar "602") (LiftStar "607"))) "609") (LiftArrow (LiftStar "613") (LiftArrow (LiftParens "618" (LiftTpArrow (TpAppt (TpVar "619" "Fin") (Var "623" "n")) (LiftStar "628")) "630") (LiftArrow (LiftStar "634") (LiftStar "639")))))) "641")) "642") (TpVar "660" "Or")) (TpVar "680" "And")) (TpVar "701" "True")) (TpVar "723" "A")) (TpVar "742" "X"))))))) "744") CmdsStart))))))) "746"))
                          (runAlex cnt $ cedilleParser)))


test_lifttypes2 = TestCase (do
                        cnt <- readFile "test/tests/sysf-norm.ced"
                        (assertEqual "test file sysf-norm.ced"
                         (Prelude.Right (File "0" ImportsStart "sysf" ParamsNil (CmdsNext (ImportCmd (Import "14" "bool" NoOptAs (ArgsNil "25") "26")) (CmdsNext (ImportCmd (Import "27" "sysf" NoOptAs (ArgsNil "38") "39")) (CmdsNext (ImportCmd (Import "40" "red" NoOptAs (ArgsNil "50") "51")) (CmdsNext (ImportCmd (Import "52" "norm" NoOptAs (ArgsNil "63") "64")) (CmdsNext (DefTermOrType (DefType "67" "Candidat" (KndArrow (KndParens "78" (KndTpArrow (TpVar "79" "trm") (Star "85")) "87") (Star "90")) (TpLambda "96" "98" "R" (Tkk (KndTpArrow (TpVar "102" "trm") (Star "108"))) (Abs "114" Pi "116" "t" (Tkt (TpVar "120" "trm")) (TpArrow (TpAppt (TpVar "126" "R") (Var "128" "t")) UnerasedArrow (TpApp (TpApp (TpVar "137" "And") (TpParens "143" (TpAppt (TpVar "144" "Normalizing") (Var "156" "t")) "158")) (TpParens "169" (Abs "170" Pi "172" "t'" (Tkt (TpVar "177" "trm")) (TpArrow (TpAppt (TpAppt (TpVar "183" "red") (Var "187" "t'")) (Var "190" "t")) UnerasedArrow (TpAppt (TpVar "194" "R") (Var "196" "t'")))) "199")))))) "201") (CmdsNext (DefTermOrType (DefType "204" "ninterp" (KndArrow (KndParens "214" (KndTpArrow (TpVar "215" "Nat") (KndTpArrow (TpVar "221" "trm") (Star "227"))) "229") (KndTpArrow (TpVar "232" "tp") (KndParens "237" (KndTpArrow (TpVar "238" "trm") (Star "244")) "246"))) (TpLambda "251" "253" "R" (Tkk (KndTpArrow (TpVar "257" "Nat") (KndTpArrow (TpVar "263" "trm") (Star "269")))) (TpLambda "273" "275" "T" (Tkt (TpVar "279" "tp")) (TpApp (TpApp (TpApp (Lft "288" "290" "X" (AppTp (Var "294" "T") (TpParens "298" (TpLambda "299" "301" "_" (Tkt (TpVar "305" "tp")) (TpArrow (TpVar "310" "trm") UnerasedArrow (TpVar "316" "X"))) "318")) (LiftParens "332" (LiftArrow (LiftParens "333" (LiftTpArrow (TpVar "334" "tp") (LiftTpArrow (TpVar "340" "tp") (LiftArrow (LiftParens "346" (LiftTpArrow (TpVar "347" "trm") (LiftStar "354")) "356") (LiftArrow (LiftParens "360" (LiftTpArrow (TpVar "361" "trm") (LiftStar "368")) "370") (LiftParens "374" (LiftTpArrow (TpVar "375" "trm") (LiftStar "382")) "384"))))) "385") (LiftArrow (LiftParens "389" (LiftTpArrow (TpVar "390" "Nat") (LiftTpArrow (TpVar "397" "tp") (LiftArrow (LiftParens "403" (LiftArrow (LiftParens "404" (LiftTpArrow (TpVar "405" "trm") (LiftStar "412")) "414") (LiftParens "418" (LiftTpArrow (TpVar "419" "trm") (LiftStar "426")) "428")) "429") (LiftParens "433" (LiftTpArrow (TpVar "434" "trm") (LiftStar "441")) "443")))) "444") (LiftArrow (LiftParens "448" (LiftTpArrow (TpVar "449" "Nat") (LiftParens "456" (LiftTpArrow (TpVar "457" "trm") (LiftStar "464")) "466")) "467") (LiftParens "471" (LiftTpArrow (TpVar "472" "trm") (LiftStar "479")) "481")))) "482")) (TpParens "497" (TpLambda "498" "500" "_" (Tkt (TpVar "504" "tp")) (TpLambda "509" "511" "_" (Tkt (TpVar "515" "tp")) (TpLambda "520" "522" "S1" (Tkk (KndParens "527" (KndTpArrow (TpVar "528" "trm") (Star "534")) "536")) (TpLambda "539" "541" "S2" (Tkk (KndParens "546" (KndTpArrow (TpVar "547" "trm") (Star "553")) "555")) (TpLambda "558" "560" "t" (Tkt (TpVar "564" "trm")) (TpApp (TpApp (TpVar "578" "And") (TpParens "584" (TpAppt (TpVar "585" "Normalizing") (Var "597" "t")) "599")) (TpParens "602" (Abs "603" Pi "605" "t'" (Tkt (TpVar "610" "trm")) (TpArrow (TpAppt (TpVar "616" "S1") (Var "619" "t'")) UnerasedArrow (TpAppt (TpVar "624" "S2") (Parens "627" (App (App (Var "628" "app") NotErased (Var "632" "t")) NotErased (Var "634" "t'")) "637")))) "638"))))))) "639")) (TpParens "647" (TpLambda "648" "650" "_" (Tkt (TpVar "654" "Nat")) (TpLambda "660" "662" "_" (Tkt (TpVar "666" "tp")) (TpLambda "671" "673" "S" (Tkk (KndArrow (KndParens "677" (KndTpArrow (TpVar "678" "trm") (Star "684")) "686") (KndParens "689" (KndTpArrow (TpVar "690" "trm") (Star "696")) "698"))) (TpLambda "701" "703" "t" (Tkt (TpVar "707" "trm")) (Abs "722" All "724" "R" (Tkk (KndTpArrow (TpVar "728" "trm") (Star "734"))) (TpArrow (TpApp (TpVar "738" "Candidat") (TpVar "749" "R")) UnerasedArrow (TpAppt (TpApp (TpVar "753" "S") (TpVar "757" "R")) (Var "759" "t")))))))) "761")) (TpVar "769" "R"))))) "772") (CmdsNext (DefTermOrType (DefType "774" "All-normalizing" (KndTpArrow (TpVar "792" "trm") (Star "798")) (TpLambda "804" "806" "t" (Tkt (TpVar "810" "trm")) (TpAppt (TpVar "816" "Normalizing") (Var "828" "t")))) "831") (CmdsNext (DefTermOrType (DefTerm "833" "all-normalizing-red-lem" (Type (TpApp (TpVar "859" "Candidat") (TpVar "870" "All-normalizing"))) (Lam "890" KeptLambda "892" "t" NoClass (Lam "896" KeptLambda "898" "pf" NoClass (App (App (AppTp (AppTp (Var "907" "mkpair") (TpParens "922" (TpAppt (TpVar "923" "Normalizing") (Var "935" "t")) "937")) (TpParens "946" (Abs "947" Pi "949" "t'" (Tkt (TpVar "954" "trm")) (TpParens "960" (TpArrow (TpParens "961" (TpAppt (TpAppt (TpVar "962" "red") (Var "966" "t'")) (Var "969" "t")) "971") UnerasedArrow (TpParens "974" (TpAppt (TpVar "975" "Normalizing") (Var "987" "t'")) "990")) "991")) "992")) NotErased (Var "999" "pf")) NotErased (Parens "1008" (Lam "1009" KeptLambda "1011" "t'" NoClass (Lam "1016" KeptLambda "1018" "r" NoClass (Parens "1022" (App (App (App (App (Var "1023" "norm-lem") NotErased (Var "1032" "t")) NotErased (Var "1034" "t'")) NotErased (Var "1037" "pf")) NotErased (Parens "1040" (App (App (App (AppTp (AppTp (Var "1041" "rtc-step") (TpVar "1052" "trm")) (TpVar "1058" "red")) NotErased (Var "1062" "t'")) NotErased (Var "1065" "t")) NotErased (Var "1067" "r")) "1069")) "1070"))) "1071"))))) "1073") (CmdsNext (DefTermOrType (DefTerm "1076" "reducibility-lem" (Type (Abs "1095" Pi "1097" "T" (Tkt (TpVar "1101" "tp")) (Abs "1106" All "1108" "R" (Tkk (KndParens "1112" (KndTpArrow (TpVar "1113" "Nat") (KndTpArrow (TpVar "1119" "trm") (Star "1125"))) "1127")) (TpArrow (TpParens "1130" (Abs "1131" Pi "1133" "i" (Tkt (TpVar "1137" "Nat")) (TpApp (TpVar "1143" "Candidat") (TpParens "1154" (TpAppt (TpVar "1155" "R") (Var "1157" "i")) "1159"))) "1160") UnerasedArrow (TpApp (TpVar "1163" "Candidat") (TpParens "1174" (TpAppt (TpApp (TpVar "1175" "ninterp") (TpVar "1185" "R")) (Var "1187" "T")) "1189")))))) (Lam "1195" KeptLambda "1197" "T" NoClass (Theta "1202" Abstract (Var "1204" "T") (LtermsCons NotErased (Parens "1227" (Lam "1228" KeptLambda "1230" "T1" NoClass (Lam "1235" KeptLambda "1237" "T2" NoClass (Lam "1242" KeptLambda "1244" "_" NoClass (Lam "1248" KeptLambda "1250" "ih2" NoClass (Lam "1256" ErasedLambda "1258" "R" NoClass (Lam "1262" KeptLambda "1264" "cr" NoClass (Lam "1269" KeptLambda "1271" "t" NoClass (Lam "1275" KeptLambda "1277" "u" NoClass (Theta "1289" Abstract (Var "1291" "u") (LtermsCons NotErased (Parens "1303" (Lam "1304" KeptLambda "1306" "a" NoClass (Lam "1310" KeptLambda "1312" "b" NoClass (App (App (AppTp (AppTp (Var "1328" "mkpair") (TpParens "1344" (TpAppt (TpVar "1345" "Normalizing") (Var "1357" "t")) "1359")) (TpParens "1369" (Abs "1370" Pi "1372" "t'" (Tkt (TpVar "1377" "trm")) (TpParens "1383" (TpArrow (TpParens "1384" (TpAppt (TpAppt (TpVar "1385" "red") (Var "1389" "t'")) (Var "1392" "t")) "1394") UnerasedArrow (TpParens "1397" (TpAppt (TpAppt (TpApp (TpVar "1398" "ninterp") (TpVar "1408" "R")) (Parens "1410" (App (App (Var "1411" "arrow") NotErased (Var "1417" "T1")) NotErased (Var "1420" "T2")) "1423")) (Var "1424" "t'")) "1427")) "1428")) "1429")) NotErased (Var "1437" "a")) NotErased (Parens "1446" (Lam "1447" KeptLambda "1449" "t'" NoClass (Lam "1454" KeptLambda "1456" "r" NoClass (App (App (AppTp (AppTp (Var "1469" "mkpair") (TpParens "1488" (TpAppt (TpVar "1489" "Normalizing") (Var "1501" "t'")) "1504")) (TpParens "1517" (Abs "1518" Pi "1520" "t''" (Tkt (TpVar "1526" "trm")) (TpArrow (TpParens "1532" (TpAppt (TpAppt (TpApp (TpVar "1533" "ninterp") (TpVar "1543" "R")) (Var "1545" "T1")) (Var "1548" "t''")) "1552") UnerasedArrow (TpParens "1555" (TpAppt (TpAppt (TpApp (TpVar "1556" "ninterp") (TpVar "1566" "R")) (Var "1568" "T2")) (Parens "1571" (App (App (Var "1572" "app") NotErased (Var "1576" "t'")) NotErased (Var "1579" "t''")) "1583")) "1584"))) "1585")) NotErased (Parens "1596" (App (App (App (App (Var "1597" "norm-lem") NotErased (Var "1606" "t")) NotErased (Var "1608" "t'")) NotErased (Var "1611" "a")) NotErased (Parens "1613" (App (App (App (AppTp (AppTp (Var "1614" "rtc-step") (TpVar "1625" "trm")) (TpVar "1631" "red")) NotErased (Var "1635" "t'")) NotErased (Var "1638" "t")) NotErased (Var "1640" "r")) "1642")) "1643")) NotErased (Parens "1654" (Lam "1655" KeptLambda "1657" "t''" NoClass (Lam "1663" KeptLambda "1665" "pf" NoClass (App (App (App (AppTp (AppTp (Var "1670" "snd") (TpParens "1676" (TpAppt (TpVar "1677" "Normalizing") (Parens "1689" (App (App (Var "1690" "app") NotErased (Var "1694" "t")) NotErased (Var "1696" "t''")) "1700")) "1701")) (TpParens "1734" (Abs "1735" Pi "1737" "t'" (Tkt (TpVar "1742" "trm")) (TpParens "1748" (TpArrow (TpParens "1749" (TpAppt (TpAppt (TpVar "1750" "red") (Var "1754" "t'")) (Parens "1757" (App (App (Var "1758" "app") NotErased (Var "1762" "t")) NotErased (Var "1764" "t''")) "1768")) "1769") UnerasedArrow (TpParens "1772" (TpAppt (TpAppt (TpApp (TpVar "1773" "ninterp") (TpVar "1783" "R")) (Var "1785" "T2")) (Var "1788" "t'")) "1791")) "1792")) "1793")) NotErased (Parens "1803" (App (App (App (AppTp (Var "1804" "ih2") (TpVar "1810" "R")) NotErased (Var "1812" "cr")) NotErased (Parens "1815" (App (App (Var "1816" "app") NotErased (Var "1820" "t")) NotErased (Var "1822" "t''")) "1826")) NotErased (Parens "1827" (App (App (Var "1828" "b") NotErased (Var "1830" "t''")) NotErased (Var "1834" "pf")) "1837")) "1838")) NotErased (Parens "1839" (App (App (Var "1840" "app") NotErased (Var "1844" "t'")) NotErased (Var "1847" "t''")) "1851")) NotErased (Parens "1852" (App (App (App (App (Var "1853" "red-app1") NotErased (Var "1862" "t'")) NotErased (Var "1865" "t")) NotErased (Var "1867" "t''")) NotErased (Var "1871" "r")) "1873")))) "1874")))) "1886")))) "1887") (LtermsNil "1887"))))))))))) "1888") (LtermsCons NotErased (Parens "1906" (Lam "1907" KeptLambda "1909" "i" NoClass (Lam "1913" KeptLambda "1915" "T'" NoClass (Lam "1920" KeptLambda "1922" "ih" NoClass (Lam "1927" ErasedLambda "1929" "R" NoClass (Lam "1933" KeptLambda "1935" "cr" NoClass (Lam "1940" KeptLambda "1942" "t" NoClass (Lam "1946" KeptLambda "1948" "pf" NoClass (App (App (AppTp (AppTp (Var "1961" "mkpair") (TpParens "1978" (TpAppt (TpVar "1979" "Normalizing") (Var "1991" "t")) "1993")) (TpParens "2004" (Abs "2005" Pi "2007" "t'" (Tkt (TpVar "2012" "trm")) (TpArrow (TpParens "2018" (TpAppt (TpAppt (TpVar "2019" "red") (Var "2023" "t'")) (Var "2026" "t")) "2028") UnerasedArrow (TpParens "2031" (TpAppt (TpAppt (TpApp (TpVar "2032" "ninterp") (TpVar "2042" "R")) (Parens "2044" (App (App (Var "2045" "forall") NotErased (Var "2052" "i")) NotErased (Var "2054" "T'")) "2057")) (Var "2058" "t'")) "2061"))) "2062")) NotErased (Parens "2071" (App (AppTp (AppTp (Var "2072" "fst") (TpParens "2088" (TpAppt (TpVar "2089" "Normalizing") (Var "2101" "t")) "2103")) (TpParens "2109" (Abs "2110" Pi "2112" "t'" (Tkt (TpVar "2117" "trm")) (TpParens "2123" (TpArrow (TpParens "2124" (TpAppt (TpAppt (TpVar "2125" "red") (Var "2129" "t'")) (Var "2132" "t")) "2134") UnerasedArrow (TpParens "2137" (TpAppt (TpAppt (TpApp (TpVar "2138" "ninterp") (TpParens "2148" (TpLambda "2149" "2151" "x" (Tkt (TpVar "2155" "Nat")) (TpParens "2161" (TpApp (TpApp (TpParens "2162" (Lft "2163" "2165" "X" (Parens "2169" (AppTp (App (App (Var "2170" "eqnat") NotErased (Var "2176" "x")) NotErased (Var "2178" "i")) (TpParens "2182" (TpLambda "2183" "2185" "_" (Tkt (TpVar "2189" "Bool")) (TpParens "2196" (TpArrow (TpVar "2197" "trm") UnerasedArrow (TpVar "2203" "X")) "2205")) "2206")) "2207") (LiftParens "2210" (LiftArrow (LiftParens "2211" (LiftTpArrow (TpVar "2212" "trm") (LiftStar "2219")) "2221") (LiftArrow (LiftParens "2225" (LiftTpArrow (TpVar "2226" "trm") (LiftStar "2233")) "2235") (LiftTpArrow (TpVar "2239" "trm") (LiftStar "2246")))) "2248")) "2249") (TpVar "2252" "All-normalizing")) (TpParens "2270" (TpAppt (TpVar "2271" "R") (Var "2273" "x")) "2275")) "2276")) "2277")) (Var "2278" "T'")) (Var "2281" "t'")) "2284")) "2285")) "2286")) NotErased (Parens "2297" (App (App (App (AppTp (App (Var "2298" "ih") NotErased (Parens "2301" (Lam "2302" ErasedLambda "2304" "R" NoClass (Lam "2308" KeptLambda "2310" "cr" NoClass (App (Var "2315" "cr") NotErased (Var "2318" "i")))) "2320")) (TpParens "2326" (TpLambda "2327" "2329" "x" (Tkt (TpVar "2333" "Nat")) (TpApp (TpApp (Lft "2339" "2341" "X" (AppTp (Parens "2345" (App (App (Var "2346" "eqnat") NotErased (Var "2352" "x")) NotErased (Var "2354" "i")) "2356") (TpParens "2359" (TpLambda "2360" "2362" "_" (Tkt (TpVar "2366" "Bool")) (TpArrow (TpVar "2373" "trm") UnerasedArrow (TpVar "2379" "X"))) "2381")) (LiftParens "2384" (LiftArrow (LiftParens "2385" (LiftTpArrow (TpVar "2386" "trm") (LiftStar "2393")) "2395") (LiftArrow (LiftParens "2399" (LiftTpArrow (TpVar "2400" "trm") (LiftStar "2407")) "2409") (LiftParens "2413" (LiftTpArrow (TpVar "2414" "trm") (LiftStar "2421")) "2423"))) "2424")) (TpVar "2487" "All-normalizing")) (TpParens "2505" (TpAppt (TpVar "2506" "R") (Var "2508" "x")) "2510"))) "2511")) NotErased (Parens "2517" (Lam "2518" KeptLambda "2520" "x" NoClass (Theta "2524" AbstractEq (Parens "2527" (App (App (Var "2528" "eqnat") NotErased (Var "2534" "x")) NotErased (Var "2536" "i")) "2538") (LtermsCons NotErased (Parens "2539" (Lam "2540" KeptLambda "2542" "u" NoClass (Lam "2546" KeptLambda "2548" "t" NoClass (Lam "2552" KeptLambda "2554" "pf2" NoClass (App (App (Var "2560" "all-normalizing-red-lem") NotErased (Var "2584" "t")) NotErased (Var "2586" "pf2"))))) "2590") (LtermsCons NotErased (Parens "2591" (Lam "2592" KeptLambda "2594" "u" NoClass (App (Var "2598" "cr") NotErased (Var "2601" "i"))) "2603") (LtermsNil "2603"))))) "2604")) NotErased (Var "2631" "t")) NotErased (Parens "2638" (App (AppTp (Var "2639" "pf") (TpVar "2644" "All-normalizing")) NotErased (Var "2660" "all-normalizing-red-lem")) "2684")) "2685")) "2686")) NotErased (Hole "2690"))))))))) "2701") (LtermsCons NotErased (Parens "2726" (Lam "2727" KeptLambda "2729" "i" NoClass (Lam "2733" ErasedLambda "2735" "R" NoClass (Lam "2739" KeptLambda "2741" "cr" NoClass (App (Var "2746" "cr") NotErased (Var "2749" "i"))))) "2751") (LtermsNil "2752"))))))) "2753") CmdsStart))))))))) "3011"))                          
                         (runAlex cnt $ cedilleParser)))

tests = TestList [ 
  TestLabel "test lexer"                 test_lexer
  
  --, TestLabel "test atype hole" test_atype_hole 
  --, TestLabel "test atype qvar" test_atype_qvar 
  --, TestLabel "test atype qvar qualified" test_atype_qvar2
  
  , TestLabel "test parser term"           test_parser_term 
  , TestLabel "test parser term defintion" test_parser_deftermtype 
  , TestLabel "test type arrow"            test_type_arrow 
  , TestLabel "test parser command"        test_parser_cmd 
  , TestLabel "test parser cnat module"    test_parser_cnat
  , TestLabel "test cnat.ced"              test_cnat
  , TestLabel "test nat.ced"               test_nat
  , TestLabel "test clist.ced"             test_clist
  , TestLabel "test list.ced"              test_list

  -- shift/reduce conflict in lifting types problematic test 
  , TestLabel "test lifting type"          test_parser_liftingtype
  , TestLabel "test descn.ced"             test_lifttypes
  , TestLabel "test sysf-norm.ced"         test_lifttypes2  

  ]

main = do
  count  <- Test.HUnit.runTestTT tests
  if Test.HUnit.failures count > 0    
    then Exit.exitFailure
    else return ()


